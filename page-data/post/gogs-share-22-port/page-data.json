{"componentChunkName":"component---theme-src-templates-post-template-jsx","path":"/post/gogs-share-22-port/","result":{"data":{"markdownRemark":{"html":"<p>在使用 Docker 安装 Gogs 时，一般会把容器的 22 端口映射到主机的其它端口(比如 10022)\n在以 SSH 方式 clone 项目时，URL 长这样</p>\n<blockquote>\n<p>ssh://git@git.example.com:10022:username/project.git</p>\n</blockquote>\n<p>但我们想要的是类似于 GitHub 那样的，这时需要把 Gogs 的 SSH 端口设置为 22</p>\n<blockquote>\n<p>git@git.example.com:username/project.git</p>\n</blockquote>\n<!-- more -->\n<p>下面说一下主要步骤</p>\n<h2 id=\"创建-git-用户\" style=\"position:relative;\"><a href=\"#%E5%88%9B%E5%BB%BA-git-%E7%94%A8%E6%88%B7\" aria-label=\"创建 git 用户 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>创建 git 用户</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root<span class=\"token punctuation\">]</span>$ <span class=\"token function\">useradd</span> <span class=\"token function\">git</span>\n<span class=\"token punctuation\">[</span>root<span class=\"token punctuation\">]</span>$ <span class=\"token function\">id</span> <span class=\"token function\">git</span>    <span class=\"token comment\"># 获取uid和gid</span>\n<span class=\"token assign-left variable\">uid</span><span class=\"token operator\">=</span><span class=\"token number\">1002</span><span class=\"token punctuation\">(</span>git<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">gid</span><span class=\"token operator\">=</span><span class=\"token number\">1002</span><span class=\"token punctuation\">(</span>git<span class=\"token punctuation\">)</span> <span class=\"token assign-left variable\">groups</span><span class=\"token operator\">=</span><span class=\"token number\">1002</span><span class=\"token punctuation\">(</span>git<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">[</span>root<span class=\"token punctuation\">]</span>$ <span class=\"token function\">usermod</span> -aG docker <span class=\"token function\">git</span>    <span class=\"token comment\"># 把git用户加入docker组</span>\n<span class=\"token punctuation\">[</span>root<span class=\"token punctuation\">]</span>$ <span class=\"token function\">su</span> <span class=\"token function\">git</span>\n<span class=\"token punctuation\">[</span>git<span class=\"token punctuation\">]</span>$ <span class=\"token function\">mkdir</span> -p ~/gogs/data   <span class=\"token comment\"># 在git用户下创建gogs/data文件夹，作为gogs容器主要数据的挂载目录</span></code></pre></div>\n<h2 id=\"安装-gogs\" style=\"position:relative;\"><a href=\"#%E5%AE%89%E8%A3%85-gogs\" aria-label=\"安装 gogs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>安装 Gogs</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>git<span class=\"token punctuation\">]</span>$ docker run -d --name<span class=\"token operator\">=</span>gogs -p <span class=\"token number\">10022</span>:22 -p <span class=\"token number\">10080</span>:3000 -v ~/gogs/data:/data -e <span class=\"token string\">\"PUID=1002\"</span> -e <span class=\"token string\">\"PGID=1002\"</span> --restart<span class=\"token operator\">=</span>always gogs/gogs     <span class=\"token comment\"># PUID PGID与上面获取的uid gid保持一致</span>\n<span class=\"token punctuation\">[</span>git<span class=\"token punctuation\">]</span>$ <span class=\"token function\">ln</span> -s ~/gogs/data/git/.ssh ~/    <span class=\"token comment\"># 将gogs的.ssh目录软连接到本地的.ssh</span></code></pre></div>\n<p>现在可以通过服务器外网 ip:10080 进入安装页面，也可以等反代设置好后通过域名进行访问我用的数据库是 Sqlite3，不需要额外配置，如果你选择的是其它数据库，可以参考<a href=\"https://www.jianshu.com/p/424627516ef6\">这篇文章</a>\n相关配置可以参考<a href=\"https://gogs.io/docs/advanced/configuration_cheat_sheet\">官方文档</a></p>\n<h2 id=\"生成-ssh-key\" style=\"position:relative;\"><a href=\"#%E7%94%9F%E6%88%90-ssh-key\" aria-label=\"生成 ssh key permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>生成 SSH key</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>git<span class=\"token punctuation\">]</span>$ ssh-keygen -t rsa -b <span class=\"token number\">4096</span> -C <span class=\"token string\">\"git@git.example.com\"</span>\n<span class=\"token punctuation\">[</span>git<span class=\"token punctuation\">]</span>$ <span class=\"token builtin class-name\">cd</span> ~/.ssh\n<span class=\"token punctuation\">[</span>git<span class=\"token punctuation\">]</span>$ <span class=\"token function\">cat</span> id_rsa.pub <span class=\"token operator\">>></span> authorized_keys\n<span class=\"token punctuation\">[</span>git<span class=\"token punctuation\">]</span>$ <span class=\"token function\">chmod</span> <span class=\"token number\">600</span> authorized_keys</code></pre></div>\n<p>在 authorized_keys 最前面添加</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">no-port-forwarding,no-X11-forwarding,no-agent-forwarding,no-pty ssh-rsa AAAAB3NzaC1y<span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span><span class=\"token punctuation\">..</span>YGedddqAN6w<span class=\"token operator\">==</span> git@git.example.com</code></pre></div>\n<h2 id=\"caddy-反向代理\" style=\"position:relative;\"><a href=\"#caddy-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86\" aria-label=\"caddy 反向代理 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Caddy 反向代理</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root<span class=\"token punctuation\">]</span>$ <span class=\"token function\">mkdir</span> caddy <span class=\"token operator\">&amp;&amp;</span> <span class=\"token builtin class-name\">cd</span> <span class=\"token variable\">$_</span></code></pre></div>\n<p>在 caddy 目录下创建 Caddyfile 文件，下面是参考配置</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">git.example.com {\n    tls git@example.com     # 填写你的邮箱，用于申请证书\n    proxy / your-ip:10080\n    header / Strict-Transport-Security &quot;max-age=31536000;&quot;      # 开启HSTS\n    gzip\n}</code></pre></div>\n<h3 id=\"启动-caddy\" style=\"position:relative;\"><a href=\"#%E5%90%AF%E5%8A%A8-caddy\" aria-label=\"启动 caddy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>启动 caddy</h3>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root<span class=\"token punctuation\">]</span>$ docker run -d --name<span class=\"token operator\">=</span>caddy -v ~/caddy/Caddyfile:/etc/Caddyfile -v ~/.caddy:/root/.caddy -p <span class=\"token number\">80</span>:80 -p <span class=\"token number\">443</span>:443 --restart<span class=\"token operator\">=</span>always abiosoft/caddy</code></pre></div>\n<h2 id=\"配置-git-用户登录问题\" style=\"position:relative;\"><a href=\"#%E9%85%8D%E7%BD%AE-git-%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E9%97%AE%E9%A2%98\" aria-label=\"配置 git 用户登录问题 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>配置 git 用户登录问题</h2>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token punctuation\">[</span>root<span class=\"token punctuation\">]</span>$ <span class=\"token function\">mkdir</span> -p /app/gogs/\n<span class=\"token punctuation\">[</span>root<span class=\"token punctuation\">]</span>$ <span class=\"token function\">cat</span> <span class=\"token operator\">></span>/app/gogs/gogs <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">'END'\n#!/bin/sh\nssh -p 10022 -o StrictHostKeyChecking=no git@127.0.0.1 \\\n\"SSH_ORIGINAL_COMMAND=\\\"$SSH_ORIGINAL_COMMAND\\\" $0 $@\"\nEND</span>\n<span class=\"token punctuation\">[</span>root<span class=\"token punctuation\">]</span>$ <span class=\"token function\">chmod</span> <span class=\"token number\">755</span> /app/gogs/gogs</code></pre></div>\n<blockquote>\n<p>这样就差不多完成了，下面需要在本地生成 SSH 密匙，然后在 web 端把密匙添加到 Gogs\n如果需要修改 Gogs 的配置，比如安装的时候 DOMAIN 写的 IP 现在要修改为域名，可以到/home/git/gogs/data/gogs/conf/找到 app.ini，修改完后重启 gogs 容器</p>\n</blockquote>\n<h2 id=\"参考文章\" style=\"position:relative;\"><a href=\"#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0\" aria-label=\"参考文章 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>参考文章</h2>\n<p><a href=\"http://notes.guoliangwu.com/2018/01/09/Install-and-configure-Gogs-with-openSSH-Server/\">安装 Gogs 并共享主机 22 端口</a></p>\n<p><a href=\"http://www.ateijelo.com/blog/2016/07/09/share-port-22-between-docker-gogs-ssh-and-local-system\">Share port 22 between Gogs inside Docker &#x26; the local system</a></p>","excerpt":"在使用 Docker 安装 Gogs 时，一般会把容器的 22 端口映射到主机的其它端口(比如 10022)\n在以 SSH 方式 clone 项目时，URL 长这样 ssh://git@git.example.com:10022:username/project.git…","frontmatter":{"date":"03月10, 2018","title":"Gogs 与主机共享 22 端口","tags":["Gogs","Git","SSH","Docker"]}}},"pageContext":{"slug":"/post/gogs-share-22-port/","prev":{"slug":"/post/hexo-next-optimize-leancloud/","title":"NexT 主题优化：重构 leancloud 阅读量统计模块"},"next":{"slug":"/post/yuque-netlify/","title":"语雀 + netlify 自动部署静态博客"}}}}